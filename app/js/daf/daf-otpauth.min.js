/*!
* Data Aquarium Framework - One Time Password Authentication
* Copyright 2021 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function e(n){n||(n=this);var t=n.fieldValue("Methods");return t!=null&&t.match(/app/)}function s(t,i){var e=t.data(),o=t.data("survey"),u,s=e.BackupCode,f={};return i==null&&(i=e.Passcode),(i==null||i.length===o.codeLength&&i.toString().match(/^\d+$/))&&(i!=null||s!=null)||(i!=null&&(u=i.replace(/\D/g,""),u!==i&&(i=u,r.execute({values:{Passcode:u},raiseCalculate:!1}))),f.error=String.format(n.Messages.EnterCode,o.codeLength)),f.value=i,f}function h(n){var f=n.keyboardPage?i.pageInfo(n.inputPage).dataView:i.dataView(),u=f._survey,t=u&&u.context,r;t&&t.otpauth&&(r=n.value,r.length==t.codeLength&&r.match(/^\d+$/)&&(n.keyboardPage?i.goBack():n.input.blur()))}var t=$app,r=t.input,i=t.touch,c=window,o=$(document),f=Web.DataViewResources,l=t.clientRect,u=t.html,a=u.tag,v=u.div,y=u.span,p=u.$tag,w=u.$p,b=u.$div,k=u.$span,d=u.$a,g=u.$i,nt=u.$li,tt=u.$ul,n=f.TwoFA;t.otpauth||(t.otpauth={});t.otpauth.totp={login:function(r){function e(t){t!=null&&t.forEach(function(t){u.push({value:t.type+":"+t.value,text:n.GetCode[t.type]+" "+t.text})})}var u=[];if(r.verify.app&&u.push({value:"app",text:n.AuthenticatorApp}),e(r.verify.email),e(r.verify.sms),e(r.verify.call),e(r.verify.dial),!u.length){i.notify({text:"Verification methods are unavailable.",force:!0});return}t.survey({context:r,text:n.Text,text2:t.touch.appName(),values:{Method:u[0].value,TrustThisDevice:!1},questions:[{name:"Passcode",type:"text",text:n.VerificationCode,placeholder:new Array(r.codeLength+1).join("0"),length:r.codeLength,causesCalculate:!0,options:{kbd:"pin"}},{name:"Method",text:n.Method,type:"text",causesCalculate:!0,visibleWhen:u.length>1||u.length===1&&u[0].value!=="app",columns:1,items:{style:"RadioButtonList",list:u},options:{lookup:{nullValue:!1}}},{name:"VerificationCodeMethodActions",text:!1,items:{style:"Actions"},options:{mergeWithPrevious:!0},visibleWhen:function(){var n=this.fieldValue("Method");return n&&n.match(/sms|call|email/)}},{name:"TrustThisDevice",type:"bool",text:n.TrustThisDevice,items:{style:"CheckBox"},causesCalculate:!0,visibleWhen:function(){return r.canTrustThisDevice!==!1}},{name:"BackupCode",type:"text",text:n.BackupCode.Text,placeholder:n.BackupCode.Placeholder,footer:n.BackupCode.Footer,causesCalculate:!0,visibleWhen:function(){return r.canEnterBackupCode!==!1}},],options:{modal:{fitContent:!0,autoGrow:!0,max:"xs"},materialIcon:"dialpad",discardChangesPrompt:!1},actions:[{text:n.Actions.GetVerificationCode,execute:"otpauthtotp_getcode.app",position:"before",scope:"VerificationCodeMethodActions",when:function(){var n=this.fieldValue("Method");return n&&n.match(/sms|call|email/)}}],submitText:f.Mobile.Verify,submit:"otpauthtotp_submit.app",calculate:"otpauthtotp_calculate.app"})},setup:function(n){n?t.otpauth.totp._setup(n):t.login(t.userName(),"null;otpauth:totp;exec:setup;")},_setup:function(i){function r(n){if(i.status!=="ready")return!0;n||(n=this);var t=n.fieldValue("Consent");return t!=null&&t.match(/Enable/)}var s=[],v=i.backupCodes&&i.backupCodes.length?i.backupCodes:null,u={Consent:"Enable",AppConfig:"ScanQrCode",Url:i.url,EnterSetupKey:i.secret,BackupCodes:v?v.join(", "):null,Methods:i.methods?i.methods.replace(/\s+/g,""):null,Status:i.status},o=[],h=i.setup.authenticators,l=i.setup.methods,c,a;if(!u.Methods&&l){c=[];for(a in l)l[a]&&c.push(a);c.length&&(u.Methods=c.join(","))}h&&(Array.isArray(h)||(h=[h]),h.forEach(function(n){n.name&&n.url&&o.push({value:n.url,text:n.name})}));o.length||o.push({value:"https://apps.apple.com/us/app/google-authenticator/id388497605",text:"Google Authenticator (iOS)"},{value:"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2",text:"Google Authenticator (Android)"},{value:"https://apps.apple.com/us/app/microsoft-authenticator/id983156458",text:"Microsoft Authenticator (iOS)"},{value:"https://play.google.com/store/apps/details?id=com.azure.authenticator",text:"Microsoft Authenticator (Android)"},{value:"https://apps.apple.com/us/app/salesforce-authenticator/id782057975",text:"Salesforce Authenticator (iOS)"},{value:"https://play.google.com/store/apps/details?id=com.salesforce.authenticator",text:"Salesforce Authenticator (Android)"});o.length===1&&(u.InstallApp=o[0].value,u.SelectedApp=u.InstallApp);i.verifyVia.email&&s.push({value:"email",text:n.VerifyVia.email});i.verifyVia.sms&&s.push({value:"sms",text:n.VerifyVia.sms});i.verifyVia.call&&s.push({value:"call",text:n.VerifyVia.call});i.verifyVia.app&&s.push({value:"app",text:n.VerifyVia.app});t.survey({context:i,text:n.Text,text2:t.touch.appName(),values:u,questions:[{name:"Consent",text:n.Consent,required:i.status!=="ready",items:{style:"CheckBoxList",list:[{value:"Enable",text:n.Setup.Consent}]}},{name:"Methods",type:"text",text:n.Setup.Methods,required:!0,items:{style:"CheckBoxList",list:s},visibleWhen:r},{name:"AppConfig",required:!0,items:{style:"RadioButtonList",list:[{value:"ScanQrCode",text:n.Setup.AppConfigScanQrCode},{value:"EnterSetupKey",text:n.Setup.AppConfigEnterSetupKey},{value:"InstallApp",text:n.Setup.AppConfigInstallApp},]},visibleWhen:function(){return i.verifyVia.app&&r(this)&&e(this)}},{name:"Url",text:n.Setup.ScanQrCode,options:{input:{qrcode:{valueHidden:!0,tooltipHidden:!0,scrollIntoView:!u.Methods||!u.Methods.match(/app/),size:"192x192"}}},visibleWhen:function(){var n=this.fieldValue("AppConfig");return i.verifyVia.app&&r(this)&&e(this)&&n==="ScanQrCode"}},{name:"EnterSetupKey",text:n.Setup.EnterSetupKey,mode:"static",options:{textAction:"copy"},visibleWhen:function(){var n=this.fieldValue("AppConfig");return r(this)&&e(this)&&n==="EnterSetupKey"}},{name:"InstallApp",text:n.AuthenticatorApp,required:!0,items:{style:"RadioButtonList",list:o},columns:1,causesCalculate:!0,visibleWhen:function(){var n=this.fieldValue("AppConfig");return r(this)&&e(this)&&n==="InstallApp"&&o.length>1}},{name:"SelectedApp",text:n.Setup.ScanAppQrCode,options:{input:{qrcode:{valueHidden:!0,scrollIntoView:!0,size:"192x192"}}},visibleWhen:function(){var n=this.fieldValue("AppConfig"),t=this.fieldValue("InstallApp");return r(this)&&e(this)&&n==="InstallApp"&&t}},{name:"BackupCodes",text:n.Setup.BackupCodes.Text,mode:"static",htmlEncode:!1,footer:n.Setup.BackupCodes.Footer,options:{textAction:"copy"},visibleWhen:function(){return r(this)&&this.fieldValue("Methods")&&this.fieldValue("Status")==="ready"&&this.fieldValue("BackupCodes")}},{name:"BackupCodeActions",text:!1,rows:1,items:{style:"Actions"},options:{mergeWithPrevious:!0},visibleWhen:function(){return r(this)&&this.fieldValue("Methods")&&this.fieldValue("Status")==="ready"&&this.fieldValue("BackupCodes")}},{name:"BackupCodesUnavailable",text:n.Setup.BackupCodes.Text,rows:1,items:{style:"Actions"},footer:n.Setup.BackupCodes.Footer,visibleWhen:function(){return r(this)&&this.fieldValue("Methods")&&this.fieldValue("Status")==="ready"&&!this.fieldValue("BackupCodes")}},{name:"Status",hidden:!0}],options:{modal:{fitContent:!0,autoGrow:!0,max:"sm"},materialIcon:"dialpad",discardChangesPrompt:!1},actions:[{text:f.Mobile.Next,execute:"otpauthtotpsetup_next.app",scope:"form",icon:"material-icon-arrow_forward",when:function(){return this.fieldValue("Status")!="ready"&&(!e(this)||this.fieldValue("AppConfig")!=="InstallApp")}},{text:i.status==="ready"?f.ModalPopup.SaveButton:f.Mobile.Enable,execute:"otpauthtotpsetup_save.app",scope:"form",icon:"material-icon-check",when:function(){return this.fieldValue("Status")==="ready"}},{text:f.ModalPopup.SaveButton,execute:"otpauthtotpsetup_backupcodessave.app",scope:"BackupCodeActions",causesValidation:!1},{text:f.Mobile.Generate,execute:"otpauthtotpsetup_backupcodesgenerate.app",scope:"BackupCodeActions",causesValidation:!1},{text:f.Mobile.Generate,execute:"otpauthtotpsetup_backupcodesgenerate.app",scope:"BackupCodesUnavailable",causesValidation:!1}],calculate:"otpauthtotpsetup_calculate.app"})},exec:function(u,f){function s(n,t){t!=null&&c.push(n+":"+(t==null?"null":t)+";")}var h;if(!i.busy()){var l=f.dataView||i.dataView(),e=l.data("survey"),c=[(e.password||"null")+";"];s("otpauth",e.otpauth);s("exec",u);for(h in f)s(h,f[h]);t.login(e.username,c.join(""),e.createPersistentCookie,function(n){i.busy(!0);e.callback?e.callback.success(n):n.event&&o.trigger($.Event(n.event,{args:n}))},function(){var u=i.dataView().data("survey").confirm,f=u==="verification_code"?n.Messages.InvalidVerificationCode:n.Messages.InvalidPassword;t.alert(f).then(function(){r.focus({field:u==="password"?"Password":"Passcode"})})})}}};o.on("otpauthtotp_submit.app",function(n){var f=n.dataView.data(),u=n.dataView.data("survey"),e=f.BackupCode,i=s(n.dataView);return i.error?t.alert(i.error).then(function(){r.focus({field:"Passcode"})}):(i=i.value,i==null&&(i=e),i=i.toString(),t.otpauth.totp.exec(n.dataView.data("survey").exec||"login",{passcode:i,trustThisDevice:f.TrustThisDevice,url:u.url,backupCodes:u.backupCodes,methods:u.methods})),!1}).on("otpauthtotp_getcode.app",function(u){var o;r.focus({field:"Passcode"});var e=u.dataView.data().Method.match(/^(\w+)\:(.+)$/),h=u.dataView.data("survey"),c,s=h.verify[e[1]];for(o=0;o<s.length;o++)s[o].value===e[2]&&(c=n.CodeSent[e[1]]+" "+s[o].text);return t.otpauth.totp.exec("send",{method:e[2],type:e[1],url:h.url,template:String.format(n.Messages.YourCode,i.appName()),confirmation:c}),setTimeout(function(){r.focus({field:"Passcode"})}),i.notify({text:f.Mobile.Wait,force:!0}),!1}).on("otpauthtotp_calculate.app",function(n){var i=n.rules._args.trigger,t=n.dataView,e=t.fieldValue("Passcode"),h=t.fieldValue("BackupCode"),u,f;return i==="Method"&&(u=t.fieldValue("Method"),u&&u.match(/^dial|app/)&&setTimeout(function(){r.focus({field:"Passcode"})})),i==="Passcode"&&(f=s(t),h!=null&&e!=null&&r.execute({BackupCode:null}),f.error||f.value==null||o.trigger($.Event("otpauthtotp_submit.app",{dataView:t,survey:t._survey}))),i==="BackupCode"&&h!=null&&e!=null&&r.execute({Passcode:null}),i==="TrustThisDevice"&&setTimeout(function(){r.focus({field:"Passcode"})}),!1}).on("beforefocus.input.app",'[data-field="Passcode"][data-type="pin"]',function(n){n.inputElement.data("change",h)}).on("beforefocus.keyboard.app",'[data-field="Passcode"][data-type="pin"]',function(n){n.context.change=h});o.on("otpauthtotpsetup_calculate.app",function(n){var i=n.rules._args.trigger,u=n.dataView,t;return i==="InstallApp"&&(t=u.fieldValue("InstallApp"),r.execute({SelectedApp:t})),!1}).on("otpauthtotpsetup_verificationcodesent.app",function(n){return i.notify({text:n.args.notify,force:!0}),!1}).on("otpauthtotpsetup_backupcodessave.app",function(){var n=i.dataView().data("survey").backupCodes,r=t.touch.appName()+" backup codes.txt";return t.saveFile(r,n.join("\r\n")),!1}).on("otpauthtotpsetup_backupcodesgenerate.app",function(n){var i=n.dataView.data("survey");return t.otpauth.totp.exec("generate",{url:i.url}),!1}).on("otpauthtotpsetup_backupcodesgeneratedone.app",function(n){var t=i.dataView().data("survey");return t.backupCodes=n.args.newBackupCodes,r.execute({BackupCodes:n.args.newBackupCodes.join(", ")}),setTimeout(function(){r.focus({field:"BackupCodeActions"})}),!1}).on("otpauthtotpsetup_next.app",function(n){return r.execute({Status:"ready"}),setTimeout(function(){r.focus({field:n.dataView.fieldValue("BackupCodes")?"BackupCodeActions":"BackupCodesUnavailable"})}),!1}).on("otpauthtotpsetup_save.app",function(i){function u(){t.otpauth.totp.exec("setup",{consent:r.Consent,url:f.url,backupCodes:r.BackupCodes,methods:r.Methods})}var r=i.dataView.data(),f=i.dataView.data("survey");return r.Consent?u():t.confirm(n.Messages.DisableQuestion).then(u),!1}).on("otpauthtotpsetup_confirm.app",function(i){return i.args.confirm==="verification_code"?t.otpauth.totp.login(i.args.options):i.args.confirm==="password"&&t.survey({context:i.args.options,text:n.Text,text2:t.touch.appName(),questions:[{name:"Password",mode:"password",text:n.EnterPassword,required:!0}],options:{modal:{fitContent:!0,max:"xs"},materialIcon:"password",discardChangesPrompt:!1},submitText:f.Mobile.Next,submit:"otpauthtotppassword_submit.app"}),!1}).on("otpauthtotppassword_submit.app",function(n){return t.otpauth.totp.exec(n.dataView.data("survey").exec,{password:n.dataView.fieldValue("Password")}),!1}).on("otpauthtotpsetup.app",function(n){var r=i.dataView().data("survey");return n.args.verifyVia=r.verifyVia,n.args.setup=r.setup||{},i.goBack(function(){t.otpauth.totp.setup(n.args)}),!1}).on("otpauthtotpsetup_complete.app",function(r){var u=r.args.setupType;return i.goBack(function(){u==="none"?t.alert(n.Messages.Disabled):i.goBack(function(){t.alert(u==="new"?n.Messages.Enabled:n.Messages.Changed)})}),!1})})();